
<!DOCTYPE html>
<html lang="en">
<head>
<title>${K.WebSite_Admin_Name!}-${K.WebSite_Name!}</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/bootstrap-responsive.min.css" />
<link rel="stylesheet" href="/css/fullcalendar.css" />
<link rel="stylesheet" href="/css/matrix-style.css" />
<link rel="stylesheet" href="/css/matrix-media.css" />
<link href="/font-awesome/css/font-awesome.css" rel="stylesheet" />
<link rel="stylesheet" href="/css/jquery.gritter.css" />
</head>
<body>

<#include "inc/admin_header.html"/>

<!-- 导航条 -->
<!--main-container-part-->
<div id="content">
<!--breadcrumbs-->
  <div id="content-header">
    <div id="breadcrumb"> <a href="/user" title="Go to Home" class="tip-bottom"><i class="icon-home"></i> 首页</a></div>
  </div>
<!--End-breadcrumbs-->




    <div class="widget-box" style="width:98%;margin-left:1%;">
        <div class="widget-title"> <span class="icon"> <i class="icon-align-justify"></i> </span>
          <h5>生产订单详情</h5>
        </div>
        <div class="widget-content nopadding">
            <div  class="form-horizontal" >
			<br>
              <div class="control-group">
                <label class="control-label">订单号 :</label>
                <div class="controls">
                  <p class="span6" style="margin-top: 5px;margin-left: 0px;">S${r.id!}</p>
                </div>
              </div>

              <div class="control-group">
                <label class="control-label">订单状态 :</label>
                <div class="controls">
                  <p class="span6" style="margin-top: 5px;margin-left: 0px;">
                    <#if r.state==-100>开始重做，客户快递或上门返还衣物</#if>
                    <#if r.state==-101>重做中</#if>
                    <#if r.state==-102>店铺收到重做完成货物</#if>
                    <#if r.state==-10>开始返修，客户快递或上门返还衣物</#if>
                    <#if r.state==-11>返修中</#if>
                    <#if r.state==-12>店铺收到返修完成货物</#if>
                    <#if r.state==0>新订单，待审核</#if>
                    <#if r.state==1>已审核，未付款</#if>
                    <#if r.state==2>已付款，待生产</#if>
                    <#if r.state==10>生产中</#if>
                    <#if r.state==20>生产完毕，等待发往店铺</#if>
                    <#if r.state==30>正在发送到店铺</#if>
                    <#if r.state==50>店铺已收到包裹</#if>
                    <#if r.state==60>店铺已发货至客户或客户收到货物</#if>
                    <#if r.state==70>维修订单,店铺已发货至客户或客户收到货物</#if>
                    <#if r.state==100>订单完成</#if>
                    <#if r.state==-200>退款订单</#if>
                  </p>
                </div>
              </div>

              <div class="control-group">
                <label class="control-label">承运门店 :</label>
                <div class="controls">
                  <p class="span6" style="margin-top: 5px;margin-left: 0px;">

                    <#list sp as x>
                      <#if x.id==r.shop>${x.name!}</#if>
                    </#list>

                  </p>
                </div>
              </div>

            <div class="control-group">
              <label class="control-label">收件人 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.name!}</p>
              </div>
            </div>
            
            <div class="control-group">
              <label class="control-label">性别 :</label>
              <div class="controls">
          		<#if r.sex=='1'>
                 <p class="span6" style="margin-top: 5px;margin-left: 0px;">男</p>
                 <#else>
                 <p class="span6" style="margin-top: 5px;margin-left: 0px;">女</p>
                 </#if>
              </div>
            </div>
            
            <div class="control-group">
              <label class="control-label">身高 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.cm!}</p>
              </div>
            </div>
            
            <div class="control-group">
              <label class="control-label">体重 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.kg!}</p>
              </div>
            </div>
            
            <div class="control-group">
              <label class="control-label">年龄 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.age!}</p>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label">收件人电话 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.tel!}</p>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label">收件人地址 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.address!}</p>
              </div>
            </div>
            <#if ltdouser??>
            <div class="control-group">
              <label class="control-label">量体师姓名 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${ltdouser.name!}</p>
              </div>
            </div>
            
            
            <div class="control-group">
              <label class="control-label">量体师电话 :</label>
              <div class="controls">
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${ltdouser.tel!}</p>
              </div>
            </div>
			</#if>
            <div class="control-group">
              <label class="control-label">订单数据 :</label>
              <div class="controls" >


            <TABLE borderColor=#cccccc cellSpacing=8 cellPadding=4 width=300 align=center border=1 style="margin-left:0px;;width:90%">
<TBODY>
<TR>
<TD>

  <P style="color:red;">以下为量体数据：</P>
  <#list ltdata as x>
  <P>${x.name!}：${x.value!} </P>
  </#list>
  <P style="color:red;">以下为定制数据：</P>
  <#list data as x>
  <P>${x.name!}：${x.value!} </P>
  </#list>

  <P><font color="red">订单备注：</font>
  <button class="btn btn-info" style="margin-right:10px;" onclick="addonclick()">添加备注</button></p>
  <p>${r.remark!}</P>
  <div id="returnremake" style="display:none">
	  <textarea rows="2" cols="2" id="returninfo"></textarea>
	  <span id="onclickurl" style="display:none"></span>
	  <button class="btn btn-info" style="margin-right:10px;" id="subdo" onclick="subdoonclick()">确认</button>
  </div>
</TD></TR></TBODY></TABLE>
              <br/>
              <a href="/admin/showmake?id=${r.id!}" target="_self">查看生产工单</a>
              <br/>
              </div>
            </div>


            <div class="control-group">
              <label class="control-label">订单价格 :</label>
              <div class="controls">
                <#if r.state==0>
                <input type="text" class="span6" value="${r.price!}" id="price">
                <#else>
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.price!}</p>
                </#if>
              </div>
            </div>
            <#if r.state gt 1>
            <#if admin_user.power=="gl">
            <div class="control-group">
              <label class="control-label">生产工厂 :</label>
              <div class="controls">
                <#if r.state==2>
                <select type="text" class="span6" id="fc">
                
                  <#list fc as x>
                  <option value="${x.id!}">${x.name!}</option>
                  </#list>
                
                </select>
                <#else>
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">
                  <#list fc1 as x>
						${x.name!}
					</#list>
                </p>
                </#if>
              </div>
            </div>
            </#if>
            </#if>

            <#if r.state gt 10>


            <div class="control-group">
              <label class="control-label">快递单号或取货方式 :</label>
              <div class="controls">
                <#if r.state==20>
                <input type="text" class="span6" id="kddh" placeholder="请输入承运快递和快递单号或取货方式">
                <#else>
                <p class="span6" style="margin-top: 5px;margin-left: 0px;">${r.kddh!}</p>
                </#if>
              </div>
            </div>
            </#if>



            <div class="form-actions">
              <button type="button" id="btn_back" class="btn btn-warning" onclick="window.history.go(-1);">返回</button>
              <#if r.state==0><button type="button" id="btn_back" class="btn btn-success" onclick="passmakeorderexamine();">通过审核</button></#if>
              <#if r.state==0><button type="button" id="btn_back" class="btn btn-warning" onclick="orderinvalid();">订单无效</button></#if>
              <#if r.state==1>
              <button type="button" id="btn_back" class="btn btn-success" onclick="pay();">线下收款</button>
              <button type="button" id="btn_back" class="btn btn-success" onclick="window.location.href='/admin/editshowmakeorder?id=${r.id!}'">编辑订单</button>
              </#if>
              <#if r.state==2>
              <button type="button" id="btn_back" class="btn btn-success" onclick="makeing();">安排生产</button>
              <button type="button" id="btn_back" class="btn btn-success" onclick="editorder('${r.id!}')">编辑订单</button>
              </#if>
              <#if r.state==10><button type="button" id="btn_back" class="btn btn-success" onclick="makeed();">生产完毕</button></#if>
              <#if r.state==20><button type="button" id="btn_back" class="btn btn-success" onclick="shipped();">发货至店铺</button></#if>
              <#if r.state==30><button type="button" id="btn_back" class="btn btn-success" onclick="delivered();">店铺收到货物</button></#if>
              <#if r.state==50><button type="button" id="btn_back" class="btn btn-success" onclick="lastdelivered();">客户收到货物</button></#if>
              <#if r.state==70 || r.state==80 ||r.state==60><button type="button" id="btn_back" class="btn btn-success" onclick="repair();">返修</button></#if>

              <#if r.state==70 || r.state==80 ||r.state==60><button type="button" id="btn_back" class="btn btn-success" onclick="agenrepair();">重做</button></#if>


              <#if r.state==-10><button type="button" id="btn_back" class="btn btn-success" onclick="repairshopdelivered();">门店收到衣物</button></#if>
              <#if r.state==-11><button type="button" id="btn_back" class="btn btn-success" onclick="repaired();">收到返修完成衣物</button></#if>
              <#if r.state==-12><button type="button" id="btn_back" class="btn btn-success" onclick="repairdelivered();">客户收到货物</button></#if>

              <#if r.state==-100><button type="button" id="btn_back" class="btn btn-success" onclick="agenrepairshopdelivered();">门店收到衣物</button></#if>
              <#if r.state==-101><button type="button" id="btn_back" class="btn btn-success" onclick="agenrepaired();">收到重做完成衣物</button></#if>
              <#if r.state==-102><button type="button" id="btn_back" class="btn btn-success" onclick="agenrepairdelivered();">客户收到货物</button></#if>

              <#if r.state gt 59><button type="button" id="btn_back" class="btn btn-success" onclick="m_ordersend();">完成订单</button></#if>
              <#if r.state==70 || r.state==80 ||r.state==60><button type="button" id="btn_back" class="btn btn-success" onclick="returngoods();">退货</button></#if>

            </div>
          </div>
        </div>
      </div>


      <script language="javascript">
      function editorder(editid){
      var editid = editid;
        alert("没有权限");
        window.location.href="/admin/showmakeorder?id="+editid;
      }
      
		// 对Date的扩展，将 Date 转化为指定格式的String
		// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
		// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
		// 例子： 
		// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
		// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
		Date.prototype.Format = function (fmt) { //author: meizz 
		    var o = {
		        "M+": this.getMonth() + 1, //月份 
		        "d+": this.getDate(), //日 
		        "h+": this.getHours(), //小时 
		        "m+": this.getMinutes(), //分 
		        "s+": this.getSeconds(), //秒 
		        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
		        "S": this.getMilliseconds() //毫秒 
		    };
		    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
		    for (var k in o)
		    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
		    return fmt;
		}
	
      function returngoods(){
        if(window.confirm('请与客户沟通，告知客户邮寄信息，并记录客户银行账户信息的账号、开户行、户名，且确认退款，是否继续退货？')){
          $.post("returngoods", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }
      function m_ordersend(){
        if(window.confirm('请确认是否完成订单，不可回退？')){
          $.post("m_ordersend", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }

      function repair(){
        if(window.confirm('请确认是否返修？')){
        	if(window.confirm('请填写理由？')){
        		$("#returnremake").show();
        		document.getElementById('onclickurl').innerText= "repair";
        		console.log($("#onclickurl"));
        		return true;
	         }
	         else 
	         return false;
	         }
        else
          return false;
          location.reload();
      }
      
      
      function addonclick(){
   		$("#returnremake").show();
   		document.getElementById('onclickurl').innerText= "addonclick";
   		console.log($("#onclickurl"));
      }

	function subdoonclick(){
		console.log($("#returninfo").val());
		if($("#returninfo").val()==""||$("#returninfo").val()==undefined||$("#returninfo").val()==null){
			alert("请输入理由！");
		}
		else{
			var nowdate = new Date().Format("yyyy-MM-dd hh:mm:ss");
			var url = document.getElementById('onclickurl').innerText;
			console.log(url);
			var remark ="${r.remark!}";
			var info = remark +nowdate+"  "+"${admin_user.name!}:"+"  "+$("#returninfo").val().replace(/\r|\n/ig,"。")+"</br/>";
			$.post(url, {id:'${r.id!}',remark:info},
	           function(data){
	             alert(data.msg);
	             if(data.code==200){
	               location.reload();
	             }
	         },'json');
         }
         location.reload();
	}

      function agenrepair(){
        if(window.confirm('请确认是否重做？')){
        	if(window.confirm('请填写理由？')){
        		$("#returnremake").show();
        		document.getElementById('onclickurl').innerText= "agenrepair";
        		console.log($("#onclickurl"));
        		return true;
	         }
	         else 
	         return false;
        }else{
          return false;
        }
        location.reload();
      }



            function repaired(){
              if(window.confirm('请确认是否收到返修衣服？')){
                $.post("repaired", {id:'${r.id!}'},
                  function(data){
                    alert(data.msg);
                    if(data.code==200){
                      location.reload();
                    }
                },'json');
                return true;
              }else{
                return false;
              }
            }
            function agenrepaired(){
              if(window.confirm('请确认是否收到重做衣服？')){
                $.post("agenrepaired", {id:'${r.id!}'},
                  function(data){
                    alert(data.msg);
                    if(data.code==200){
                      location.reload();
                    }
                },'json');
                return true;
              }else{
                return false;
              }
            }

      function repairshopdelivered(){
        if(window.confirm('请确认店铺是否收到客户返修货物？')){
          $.post("repairshopdelivered", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }
      function agenrepairshopdelivered(){
        if(window.confirm('请确认店铺是否收到客户重做货物？')){
          $.post("agenrepairshopdelivered", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }

      function lastdelivered(){
        if(window.confirm('请确认店铺是否已发货至客户或客户收到货物？')){
          $.post("lastdelivered", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }


      function repairdelivered(){
        if(window.confirm('请确认店铺是否已发货至客户或客户收到货物？')){
          $.post("repairdelivered", {id:'${r.id!}',remark:'${r.remark!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }
        


	function agenrepairdelivered(){
        if(window.confirm('请确认店铺是否已发货至客户或客户收到货物？')){
        	$.post("agenrepairdelivered", {id:'${r.id!}',remark:'${r.remark!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }




      function pay(){
        if(window.confirm('请确定是否收到款项${r.price!}元？')){
          $.post("orderpay", {id:'${r.id!}',payment:'offline'},
     				function(data){
              alert(data.msg);
       				if(data.code==200){
       					location.reload();
       				}
     			},'json');
          return true;
        }else{
          return false;
        }
      }


      function passmakeorderexamine(){
        var price =  document.getElementById("price").value;
        if(window.confirm('请确定是否通过预审，价格为'+price+'元？')){
          $.post("passmakeorderexamine", {id:'${r.id!}',price:price},
     				function(data){
              alert(data.msg);
       				if(data.code==200){
       					location.reload();
       				}
     			},'json');
          return true;
        }else{
          return false;
        }
      }

      function makeing(){
        var fc =  document.getElementById("fc").value;
        if(window.confirm('请确认是否已联系生产工厂生产？')){
          $.post("makeing", {id:'${r.id!}',fc:fc},
     				function(data){
              alert(data.msg);
       				if(data.code==200){
       					location.reload();
       				}
     			},'json');
          return true;
        }else{
          return false;
        }
      }

      function makeed(){
        if(window.confirm('请确认是否已联系生产工厂确认已生产完毕？')){
          $.post("makeed", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }


      function shipped(){
        if(window.confirm('请确认是否已联系生产工厂已发货？')){
          $.post("shipped", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }

      function shipped(){
        var kddh = document.getElementById("kddh").value;
        if(window.confirm('请确认是否已联系生产工厂已发货？')){
          $.post("shipped", {id:'${r.id!}',kddh:kddh},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }

      function delivered(){
        if(window.confirm('请确认是否收到货物？')){
          $.post("delivered", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }
      
      
     function orderinvalid(){
        if(window.confirm('请确认是否判定订单无效，订单状态无法回退，是否继续？')){
          $.post("orderinvalid", {id:'${r.id!}'},
            function(data){
              alert(data.msg);
              if(data.code==200){
                location.reload();
              }
          },'json');
          return true;
        }else{
          return false;
        }
      }



      var id = ${r.id!};


      var ty = true;

      function edit(eid,key,t){


      	var ipt = document.getElementById(eid);
      	if(ipt.readOnly){
      		ipt.readOnly = false;
      		t.innerText="提交";
      	}else{
      		var value = ipt.value;

      		$.post("editexaminevalue", {key:key, value: value,id:id},
   				function(data){
     				if(data.code==200){
     					alert("修改成功！");
     					ipt.readOnly = true;

      					t.innerText="修改";
     				}else{
     					alert("修改失败，请重试！");
     				}
   			},'json');
      	}
      }



      function topd(){

        var pd = document.getElementById("pd");
      	$.post("doorderpd", {topdid: pd.value,id:id},
   				function(data){
     				if(data.code==200){
     					alert("派单成功！");
     					location.reload();
     				}else{
     					alert("派单失败");
     				}
   			},'json');

      }


	${js!}
      </script>


  </div>
</div>

<!--end-main-container-part-->

<#include "inc/admin_footer.html"/>

</body>
</html>
